<!-- auction-order-management.component.html -->
<div class="bg-white rounded-xl shadow-md overflow-hidden">
    <!-- Header -->
    <div class="border-b border-gray-200 px-6 py-4">
      <div class="flex justify-between items-center">
        <h2 class="text-xl font-semibold">Auction Order Management</h2>
        <div class="flex items-center space-x-2">
          <span class="text-sm font-medium text-gray-500">Role:</span>
          <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-800 text-sm font-medium capitalize">
            {{ userRole }}
          </span>
        </div>
      </div>
      <p class="text-gray-500 mt-1">Manage and track auction order statuses</p>
    </div>
  
    <!-- Order Table -->
    <div class="p-6">
      <p-table [value]="orders" [loading]="loading" [rows]="10" [paginator]="true" 
               [rowsPerPageOptions]="[5,10,20]" dataKey="id">
        <ng-template pTemplate="header">
          <tr>
            <th *ngFor="let col of cols" [pSortableColumn]="col.field">
              {{ col.header }}
              <p-sortIcon [field]="col.field"></p-sortIcon>
            </th>
            <th style="width: 200px">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-order>
          <tr (click)="onRowClick(order)" class="cursor-pointer hover:bg-gray-50">
            <td>{{ order.id }}</td>
            <td>{{ order.orderDate | date:'mediumDate' }}</td>
            <td>
              <div class="font-medium truncate max-w-xs">{{ order.auctionTitle || order.auctionId || 'N/A' }}</div>
            </td>
            <td *ngIf="showSellerColumn">{{ order.sellerName || 'N/A' }}</td>
            <td *ngIf="showBuyerColumn">{{ order.buyerName || 'N/A' }}</td>
            <td class="font-semibold">${{ order.amountPaid | number:'1.2-2' }}</td>
            <td>
              <span [class]="getStatusClass(order.status)">
                {{ order.status }}
              </span>
            </td>
            <td>
              <div class="flex space-x-2" (click)="$event.stopPropagation()">
                <button 
                  (click)="showOrderDetails(order)"
                  class="flex items-center gap-2 px-3 py-1 text-sm font-medium border rounded text-gray-700 border-gray-300 hover:bg-gray-100 transition">
                  <i class="pi pi-eye text-blue-600"></i>
                </button>
                
                <!-- Pay Button (for buyer only) -->
                <button *ngIf="userRole === 'Buyer' && showPayButton(order.status)"
                        pButton pRipple
                        icon="pi pi-dollar"
                        label="Pay"
                        class="p-button-sm p-button-success"
                        (click)="initiatePayment(order)">
                </button>
                
                <!-- Status Dropdown -->
                <p-dropdown [options]="getValidStatuses(order.status)" 
                            [(ngModel)]="order.status" 
                            [disabled]="statusChangeLoading"
                            (onChange)="confirmStatusChange(order, $event.value)"
                            appendTo="body">
                  <ng-template pTemplate="dropdownicon">
                    <i class="pi pi-cog"></i>
                  </ng-template>
                  <ng-template let-status pTemplate="item">
                    <span [class]="getStatusClass(status)">{{ status }}</span>
                  </ng-template>
                </p-dropdown>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td [attr.colspan]="cols.length + 1" class="text-center py-8">
              <i class="pi pi-inbox text-3xl text-gray-300 mb-2"></i>
              <p class="text-gray-500">No orders found</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  
    <!-- Order Detail Dialog -->
    <p-dialog header="Order Details" [(visible)]="orderDetailsVisible" 
              [style]="{ width: '600px' }" [modal]="true">
      <div *ngIf="selectedOrder" class="grid grid-cols-2 gap-4">
        <div class="space-y-2">
          <div>
            <label class="text-sm font-medium text-gray-500">Order ID</label>
            <p class="font-semibold">{{ selectedOrder.id }}</p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-500">Order Date</label>
            <p>{{ selectedOrder.orderDate | date:'medium' }}</p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-500">Auction</label>
            <p class="font-semibold">{{ selectedOrder.auctionTitle }}</p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-500">Winning Bid ID</label>
            <p>{{ selectedOrder.winningBidId }}</p>
          </div>
        </div>
        
        <div class="space-y-2">
          <div>
            <label class="text-sm font-medium text-gray-500">Payment Status</label>
            <p>
              <span [ngClass]="{
                'bg-green-100 text-green-800': selectedOrder.paymentStatus,
                'bg-red-100 text-red-800': !selectedOrder.paymentStatus
              }" class="px-2 py-1 rounded text-xs">
                {{ selectedOrder.paymentStatus ? 'Success' : 'Failed' }}
              </span>
            </p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-500">Transaction ID</label>
            <p class="truncate">{{ selectedOrder.paymentTransactionId || 'N/A' }}</p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-500">Amount Paid</label>
            <p class="font-bold text-lg">${{ selectedOrder.amountPaid | number:'1.2-2' }}</p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-500">Current Status</label>
            <p>
              <span [class]="getStatusClass(selectedOrder.status)">
                {{ selectedOrder.status }}
              </span>
            </p>
          </div>
        </div>
        
        <!-- Parties Information -->
        <div class="border-t pt-4 mt-4 col-span-2">
          <h4 class="font-medium mb-2">Parties Information</h4>
          <div class="grid grid-cols-2 gap-4">
            <!-- Seller Info -->
            <div class="bg-blue-50 p-3 rounded-lg" *ngIf="userRole !== 'Buyer'">
              <div class="flex justify-between items-center">
                <label class="text-sm font-medium text-gray-500">Seller</label>
                <span *ngIf="userRole === 'Seller'" class="text-xs text-gray-500">(You)</span>
              </div>
              <p class="font-semibold">{{ selectedOrder.sellerName || 'N/A' }}</p>
              <p *ngIf="userRole === 'Admin' || userRole === 'Buyer'" class="text-xs text-gray-500 mt-1">
                ID: {{ selectedOrder.sellerId || 'N/A' }}
              </p>
            </div>
            
            <!-- Buyer Info -->
            <div class="bg-green-50 p-3 rounded-lg" *ngIf="userRole !== 'Seller'">
              <div class="flex justify-between items-center">
                <label class="text-sm font-medium text-gray-500">Buyer</label>
                <span *ngIf="userRole === 'Buyer'" class="text-xs text-gray-500">(You)</span>
              </div>
              <p class="font-semibold">{{ selectedOrder.buyerName || 'N/A' }}</p>
              <p *ngIf="userRole === 'Admin' || userRole === 'Seller'" class="text-xs text-gray-500 mt-1">
                <!-- ID: {{ selectedOrder.buyerId || 'N/A' }} -->
              </p>
            </div>
          </div>
        </div>
      </div>
    </p-dialog>
  </div>

  <p-confirmDialog></p-confirmDialog>
  <p-toast></p-toast>