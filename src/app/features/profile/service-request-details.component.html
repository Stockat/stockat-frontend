<div *ngIf="loading" class="text-center py-8">
  <i class="pi pi-spin pi-spinner text-2xl"></i> Loading...
</div>
<div *ngIf="!loading && request">
  <div class="flex flex-col md:flex-row gap-8 items-start mb-8 bg-white rounded-2xl shadow-xl p-6 border border-pink-100 overflow-x-auto md:overflow-x-visible">
    <div *ngIf="request.imageUrl" class="flex-shrink-0 flex justify-center w-full md:w-auto">
      <img [src]="request.imageUrl" alt="Service Image" class="w-48 h-48 object-cover rounded-2xl shadow-lg border-4 border-pink-100" />
    </div>
    <div class="flex-1 w-full min-w-0">
      <h2 class="text-3xl font-bold mb-2 text-pink-700">
        <a *ngIf="request.serviceId" [routerLink]="['/services', request.serviceId]" class="hover:underline hover:text-pink-900 transition-colors">
          {{ request.serviceTitle }}
        </a>
        <span *ngIf="!request.serviceId">{{ request.serviceTitle }}</span>
      </h2>
      <div class="text-gray-600 mb-4 italic">{{ request.requestDescription }}</div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-2">
        <div class="mb-2"><b>Quantity:</b> {{ request.requestedQuantity }}</div>
        <div class="mb-2"><b>Status:</b> <span class="font-semibold" [ngClass]="{
          'text-yellow-700': request.serviceStatus === 'Pending',
          'text-blue-700': request.serviceStatus === 'InProgress',
          'text-green-700': request.serviceStatus === 'Delivered',
          'text-red-700': request.serviceStatus === 'Cancelled',
          'text-gray-700': !['Pending','InProgress','Delivered','Cancelled'].includes(request.serviceStatus)
        }"> {{ request.serviceStatus }}</span></div>
        <div class="mb-2"><b>Seller:</b> <span class="font-semibold text-pink-700">
          <a *ngIf="request.sellerId" [routerLink]="['/profile', request.sellerId]" class="hover:underline hover:text-pink-900 transition-colors">
            {{ request.sellerName || 'N/A' }}
          </a>
          <span *ngIf="!request.sellerId">{{ request.sellerName || 'N/A' }}</span>
        </span></div>
        <div class="mb-2"><b>Seller Offer:</b> <span *ngIf="request.pricePerProduct != null && request.pricePerProduct !== 0; else noOffer"> ${{ request.pricePerProduct }}</span><ng-template #noOffer><span class="text-gray-400 italic"> Not set yet</span></ng-template></div>
        <div class="mb-2"><b>Estimated Time:</b> <span *ngIf="request.estimatedTime; else noTime"> {{ request.estimatedTime }}</span><ng-template #noTime><span class="text-gray-400 italic"> Not set yet</span></ng-template></div>
        <div class="mb-2"><b>Total Price:</b> <span *ngIf="request.totalPrice; else noTotal"> {{ request.totalPrice }}$</span><ng-template #noTotal><span class="text-gray-400 italic"> Not set yet</span></ng-template></div>
        <div class="mb-2"><b>Buyer Status:</b> <span class="font-semibold" [ngClass]="{
          'text-yellow-700': request.buyerApprovalStatus === 'Pending',
          'text-green-700': request.buyerApprovalStatus === 'Approved',
          'text-red-700': request.buyerApprovalStatus === 'Rejected'
        }"> {{ request.buyerApprovalStatus || 'Pending' }}</span></div>
      </div>
      <div *ngIf="request.buyerApprovalStatus === 'Approved' && !hasPendingUpdate && request.serviceStatus === 'Pending'" class="mt-8">
        <div class="flex justify-end mb-2">
          <button pButton label="Request Update" class="p-button mb-2 bg-pink-600 border-pink-600 hover:bg-pink-700 hover:border-pink-700 text-white" (click)="openUpdateModal()"></button>
        </div>

        <!-- Modal for update creation -->
        <p-dialog header="Create Update Request" [(visible)]="updateModalVisible" [modal]="true" [closable]="true" [dismissableMask]="true" [style]="{width: '400px'}">
          <form [formGroup]="updateForm" (ngSubmit)="submitUpdate()" class="space-y-4">
            <div>
              <label class="block mb-1">Additional Price</label>
              <input pInputText type="number" formControlName="additionalPrice" class="w-full" />
            </div>
            <div>
              <label class="block mb-1">Additional Quantity</label>
              <input pInputText type="number" formControlName="additionalQuantity" class="w-full" />
            </div>
            <div>
              <label class="block mb-1">Additional Time</label>
              <input pInputText type="text" formControlName="additionalTime" class="w-full" />
            </div>
            <div>
              <label class="block mb-1">Additional Note</label>
              <textarea pInputTextarea formControlName="additionalNote" class="w-full" rows="2"></textarea>
            </div>
            <div *ngIf="updateError" class="text-red-500 text-sm">{{ updateError }}</div>
            <div *ngIf="updateSuccess" class="text-green-600 text-sm">{{ updateSuccess }}</div>
            <button pButton type="submit" label="Send Update Request" class="p-button-info w-full" [disabled]="updateLoading"></button>
          </form>
        </p-dialog>
      </div>
      <div *ngIf="request.pricePerProduct && request.estimatedTime && request.buyerApprovalStatus === 'Pending'" class="mt-8">
        <div class="flex gap-4 justify-end">
          <button pButton label="Accept Offer" class="p-button-success bg-green-600 border-green-600 hover:bg-green-700 hover:border-green-700 text-white" (click)="acceptSellerOffer(request)"></button>
          <button pButton label="Reject Offer" class="p-button-danger bg-red-600 border-red-600 hover:bg-red-700 hover:border-red-700 text-white" (click)="rejectSellerOffer(request)"></button>
        </div>
      </div>
      <div *ngIf="isNegotiationClosed()" class="mt-4 p-4 bg-red-50 border border-red-200 rounded text-red-700 font-semibold text-center">
        Negotiation closed. You rejected 3 offers from this seller.
      </div>
    </div>
  </div>
  <button pButton label="Back to Requests" class="p-button-secondary mb-6" (click)="goBack()"></button>

  <div *ngIf="updates.length > 0" class="mt-12 w-full">
    <h3 class="text-2xl font-bold mb-6 text-pink-700 flex items-center gap-2">
      <i class="pi pi-history text-xl"></i> Update History
    </h3>
    <div class="grid gap-6">
      <div *ngFor="let update of updates" class="bg-white border-l-8 border-pink-400 rounded-xl shadow-md p-6 flex flex-col gap-3 hover:shadow-xl transition-shadow max-w-3xl ml-0 mr-auto">
        <div class="flex flex-wrap gap-6 items-center mb-2">
          <div *ngIf="update.additionalPrice" class="text-pink-700 font-semibold"><i class="pi pi-dollar mr-1"></i>+{{ update.additionalPrice }}$</div>
          <div *ngIf="update.additionalQuantity" class="text-blue-700 font-semibold"><i class="pi pi-box mr-1"></i>+{{ update.additionalQuantity }}</div>
          <div *ngIf="update.additionalTime" class="text-purple-700 font-semibold"><i class="pi pi-clock mr-1"></i>{{ update.additionalTime }}</div>
        </div>
        <div *ngIf="update.additionalNote" class="italic text-gray-700 bg-pink-50 rounded p-2 border-l-4 border-pink-300"><i class="pi pi-comment mr-1"></i>{{ update.additionalNote }}</div>
        <div class="flex justify-between items-center mt-2">
          <span class="text-xs text-gray-500"><i class="pi pi-calendar mr-1"></i>Created: {{ update.createdAt | date:'medium' }}</span>
          <span class="text-xs font-bold mx-2 px-3 py-1 rounded-full"
            [ngClass]="{
              'bg-yellow-100 text-yellow-800': update.status === 'Pending',
              'bg-blue-100 text-blue-800': update.status === 'InProgress',
              'bg-green-100 text-green-800': update.status === 'Delivered',
              'bg-red-100 text-red-800': update.status === 'Cancelled',
              'bg-gray-100 text-gray-800': !['Pending','InProgress','Delivered','Cancelled'].includes(update.status)
            }">
            {{ update.status }}
          </span>
        </div>
      </div>
    </div>
  </div>
</div>
